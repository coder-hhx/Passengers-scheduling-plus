<!doctype html>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no, width=device-width">
    <title>乘客调度算法验证</title>
    <link rel="stylesheet" href="https://a.amap.com/jsapi_demos/static/demo-center/css/demo-center.css"/>
    <script src="https://webapi.amap.com/maps?v=1.4.15&key=be0af0f8f5f254e2481ebcb939a5fca7"></script>
    <script src="https://cdn.bootcss.com/jquery/3.4.1/jquery.js"></script>
    <style>
        html,
        body,
        #container {
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
        }

        .car-bg {
            width: 48px;
            height: 48px;
            background: url("/static/img/car.png");
            position: relative;
        }

        .car-font {
            text-align: center;
            line-height: 48px;
            position: absolute;
            width: 48px;
            height: 48px;
            top: 0;
            left: 0;
            color: #fc4700;
            font-size: 20px;
            bottom: 0;
            right: 0;
            margin: auto;
        }

        .p-bg {
            width: 48px;
            height: 48px;
            background: url("/static/img/people.png");
            position: relative;
        }

        .p-font {
            text-align: center;
            line-height: 48px;
            position: absolute;
            width: 48px;
            height: 48px;
            top: 0;
            left: 0;
            color: black;
            font-size: 20px;
            bottom: 0;
            right: 0;
            margin: auto;
        }

        .custom-input-card {
            width: 18rem;
        }

        .custom-input-card .btn:last-child {
            margin-left: 1rem;
        }

    </style>
</head>
<body>
<div id="container"></div>
<div class="input-card custom-input-card">
    <h4>切换算法</h4>
    <div class="input-item">
        <input type="button" class="btn" value="接场景" onClick="scene_change('receive')"/>
        <input type="button" class="btn" value="送场景" onClick="scene_change('send')"/>
    </div>
    <div class="input-item">
        <input type="button" class="btn" value="模式1-不拆分" onClick="new_arithmetic(1)"/>
        <input type="button" class="btn" value="模式2-拆分" onClick="new_arithmetic(2)"/>
    </div>
</div>
<script>
    var type = "";

    var map = new AMap.Map('container', {
        resizeEnable: true,
        zoom: 11,
        center: [116.397428, 39.90923]
    });

    function getRandomColor() {
        return '#' + Math.floor(Math.random() * 0xffffff).toString(16);
    }

    function scene_change(scene) {
        type = "scene"
        $.ajax('/scene_change/' + scene + '/', {
            type: "GET",
            dataType: "json",
            success: function (resp) {
                if (resp.status === 200) {
                    alert("场景切换成功");
                }
            }
        })
    }

    function old_arithmetic() {
        map.clearMap();
        $.ajax('/old_arithmetic', {
            type: "GET",
            dataType: "json",
            success: function (resp) {
                let data = resp.data;
                let markers = [];
                if (type === "receive") {
                    for (let i = 0; i < data.length; i++) {
                        var content = '<div class="car-bg"><b class="car-font">' + data[i].driver.id + '-' + data[i].driver.site_num + '</b></div>';
                        markers.push(new AMap.Marker({
                            content: content,
                            offset: new AMap.Pixel(-24, -24),
                            position: data[i].driver.lnglat,
                        }));

                        var color = getRandomColor();

                        for (let j = 0; j < data[i].passenger_num; j++) {
                            var lng = data[i].order.lnglat[0] + (((Math.random() * 2) - 1) / 5000);
                            var lat = data[i].order.lnglat[1] + (((Math.random() * 2) - 1) / 5000);
                            var content = '<div class="p-bg"><b class="p-font">' + data[i].order.id + '-' + data[i].passenger_num + '</b></div>';
                            markers.push(new AMap.Marker({
                                content: content,
                                position: [lng, lat],
                                offset: new AMap.Pixel(-24, -24),
                            }));

                            var polyline = new AMap.Polyline({
                                path: [data[i].driver.lnglat, [lng, lat]],
                                strokeWeight: 2,
                                isOutline: true,
                                strokeColor: color
                            });

                            map.add(polyline)
                        }
                    }
                }

                map.add(markers);
                map.setCenter(resp.center)
            }
        })
    }

    function new_arithmetic(mode) {
        map.clearMap();
        console.log(mode);
        $.ajax('/new_arithmetic/' + mode + '/', {
            type: "GET",
            dataType: "json",
            success: function (resp) {
                let data = resp.data;
                let markers = [];
                if (type === "receive") {
                    for (let i = 0; i < data.length; i++) {
                        var content = '<div class="car-bg"><b class="car-font">' + data[i].driver.id + '-' + data[i].driver.site_num + '</b></div>';
                        markers.push(new AMap.Marker({
                            content: content,
                            offset: new AMap.Pixel(-24, -24),
                            position: data[i].driver.lnglat,
                        }));

                        var color = getRandomColor();

                        content = '<div class="p-bg"><b class="p-font">' + data[i].order.id + '-' + data[i].passenger_num + '</b></div>';

                        var lng = data[i].order.lnglat[0] + (((Math.random() * 2) - 1) / 2000);
                        var lat = data[i].order.lnglat[1] + (((Math.random() * 2) - 1) / 2000);
                        markers.push(new AMap.Marker({
                            content: content,
                            position: [lng, lat],
                            offset: new AMap.Pixel(-24, -24),
                        }));

                        var polyline = new AMap.Polyline({
                            path: [data[i].driver.lnglat, [lng, lat]],
                            strokeWeight: 2,
                            isOutline: true,
                            strokeColor: color
                        });

                        map.add(polyline)
                    }
                } else {
                    for (let i = 0; i < data.length; i++) {
                        var color = getRandomColor()
                        for (let j = 0; j < data[i].length; j++) {
                            let order = data[i][j];
                            var content = '<div class="car-bg" style="background: ' + color + ';"><b class="car-font" style="color: white;">' + order.id + '-' + order.passenger_num + '</b></div>';
                            var lng = data[i].order.lnglat[0] + (((Math.random() * 2) - 1) / 2000);
                            var lat = data[i].order.lnglat[1] + (((Math.random() * 2) - 1) / 2000);
                            markers.push(new AMap.Marker({
                                content: content,
                                offset: new AMap.Pixel(-24, -24),
                                position: [lng, lat],
                            }));
                        }
                    }
                }


                map.add(markers);
                map.setCenter(resp.center)
            }
        })
    }


</script>
</body>
</html>
